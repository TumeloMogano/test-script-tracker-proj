<div class="container1">
  <div class="row">
    <div class="col-md-6">
      <box-icon name="arrow-back" color="#001844" (click)="goBack()"
        >Back</box-icon
      >
    </div>
    <div class="col-md-6 text-end">
      <box-icon
        name="comment"
        color="#001844"
        type="button"
        data-bs-toggle="offcanvas"
        data-bs-target="#offcanvasRight"
        aria-controls="offcanvasRight"
      ></box-icon>
    </div>
  </div>
  <div class="row"> 
    <div class="col text-center">
      <box-icon *ngIf="isTeamLead === true" type='solid' color="#001844" name='circle' (click)="hideTooltip('team-lead-circle')" id="team-lead-circle"
      data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Team Leader"></box-icon>
      <p *ngIf="isTeamLead === true" style="color: green; font-weight: bolder;">(You are the Team Lead!)</p>
    </div>
  </div>
  <div class="subheader1">
    <div *ngIf="testScript">
      <div *ngIf="!showEditForm; else editTestScriptDiv">
        <h2  class="user-title text-center" > {{testScript.process}}</h2>

        <div class="card text-center">
          <!-- <div class="card-header card-header-custom">
            {{ testScript.process }}
          </div> -->
          <div class="card-body">
            <p class="card-text mb-1">
              <span class="bold-text">Test:</span> {{ testScript.test }}
            </p>
            <p class="card-text mb-1">
              <span class="bold-text">Description: <br></span>
              {{ testScript.testScriptDescription }}
            </p>
            <p class="card-text mb-1">
              <span class="bold-text">Status:</span>
              {{ testScript.statusNameDisplayed }}
            </p>
            <p *ngIf="testScript.isAssigned" class="card-text mb-1 text-danger">
              <span class="bold-text">Assigned to:</span> {{userDets.userFirstName}} {{userDets.userSurname}}
            </p>
          </div>
          <div
            class="card-footer text-body-secondary">
            <box-icon  *ngIf="testScript.statusTypeId === 1 || testScript.statusTypeId === 3"
              name="edit"
              color="#001844"
              (click)="toggleEditForm(); hideTooltip('update-ts-icon')" id="update-ts-icon"
              data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Update Test Script"
            ></box-icon>
            <box-icon *ngIf="testScript.statusTypeId === 5 && testScript.isDeleted === false"
            name="archive"
            color="#ef0000"
            (click)="deleteTestScript(); hideTooltip('archive-ts-icon')" id="archive-ts-icon"
            data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Archive Test Script"
          ></box-icon>
          <box-icon *ngIf="testScript.isDeleted"
            name="archive-out"
            color="#ef0000"
            (click)="unarchiveTestScript(); hideTooltip('unarchive-ts-icon')" id="unarchive-ts-icon"
            data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Unarchive Test Script"
          ></box-icon>
            <box-icon  *ngIf="(testScript.statusTypeId === 1 || testScript.statusTypeId === 3) && testScript.isAssigned && this.canSubmit"
            name="send"
            color="#001844"
            (click)="submitTestScript(); hideTooltip('submit-ts-icon')" id="submit-ts-icon"
            data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Submit Test Script"
          ></box-icon>
          <box-icon  
          name="link-external" color="#001844" (click)="loadThemes(this.clientThemeId); hideTooltip('export-ts-icon')" id="export-ts-icon"
          data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Export Test Script"></box-icon>
          <box-icon *ngIf="testScript.isAssigned !== true && teamMembers.length>0 && (isTeamLead === true || hasPermission(Permissions.SystemAdministrator) === true)"
            name="user-pin"
            color="#001844"
            (click)="openAssignTeamMemberModal(); hideTooltip('assign-ts-icon')" id="assign-ts-icon"
            data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Assign Test Script"
          ></box-icon> 
          <box-icon *ngIf="testScript.statusTypeId === 6 || testScript.statusTypeId == 8"
            name="analyse"
            color="#001844"
            (click)="evaluateFeedback(); hideTooltip('evaluate-ts-icon')" id="evaluate-ts-icon"
            data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Evaluate Test Script"
          ></box-icon> 
         </div>
                 
          <!-- <div class="card-footer text-body-secondary" >
            <box-icon
              name="link-external"
              color="#ef0000"
              (click)="exportTss()"
            ></box-icon>
          </div>             -->
          <!-- <div class="card-body" *ngIf="testScript.isAssigned !== true && teamMembers.length>0">
            <div class="col form-group1">
             
            <div><h4>Assign to a team member:</h4></div>
            <div *ngIf="teamId">
              <label for="member-select">Select Team Member: </label>
              <select id="member-select" class="form-control1" (change)="onMemberSelect($event)">
                <option
                  *ngFor="let member of teamMembers"
                  [value]="member.userId"
                >
                  {{ member.userFirstName }} {{ member.userSurname }}
                </option>
              </select>
            </div>
          </div>
        </div> -->
        <!-- <div class="card-body" *ngIf="testScript.isAssigned !== true && teamMembers.length===0">
          <div class="col form-group1">
          <div><h4>Assign to a team member:</h4></div>
          <div><p>The test script's project does not have team members in its team.</p></div>
        </div>
      </div> -->
      </div>
    </div>
    <div class="d-flex justify-content-center mt-4" *ngIf="testScript.statusTypeId === 5">                    
      <button class="btn1 btn-primary1" style="margin-right: 10px;" (click)="recreateTs()">Recreate Test Script</button>
    </div>  
    <p-messages *ngIf="testScript.isAssigned === false && (isTeamLead === true || hasPermission(Permissions.SystemAdministrator) === true)" 
    [(value)]="IsAssignedMessages" 
    [escape]="false" [closable]="false" 
    showTransitionOptions="300ms" hideTransitionOptions="300ms">                 
    </p-messages>

    <p-messages *ngIf="testScript.statusTypeId === 1 && testScript.isAssigned === true" 
    [(value)]="IsDefectsResolvedMessages" 
    [escape]="false" [closable]="false" 
    showTransitionOptions="300ms" hideTransitionOptions="300ms">                 
    </p-messages>

    <p-messages *ngIf="testScript.statusTypeId === 3" 
    [(value)]="IsDefectsResolvedMessages2" 
    [escape]="false" [closable]="false" 
    showTransitionOptions="300ms" hideTransitionOptions="300ms">                 
    </p-messages>

    <p-messages *ngIf="testScript.statusTypeId === 6 || testScript.statusTypeId === 8 " 
    [(value)]="NeedsEvaluationMessages" 
    [escape]="false" [closable]="false" 
    showTransitionOptions="300ms" hideTransitionOptions="300ms">                 
    </p-messages>

    <p-messages *ngIf="testScript.statusTypeId === 5 && testScript.isDeleted === false" 
    [(value)]="PassedMessages" 
    [escape]="false" [closable]="false" 
    showTransitionOptions="300ms" hideTransitionOptions="300ms">                 
    </p-messages>

    <p-messages *ngIf="testScript.isAssigned === false && isTeamLead === false" 
    [(value)]="notTLAssignMember" 
    [escape]="false" [closable]="false" 
    showTransitionOptions="300ms" hideTransitionOptions="300ms">                 
    </p-messages>

    <ng-template #editTestScriptDiv>
      <form [formGroup]="editForm" (ngSubmit)="saveTestScriptDetails()">
        <div class="border border-secondary rounded" style="padding: 15px;">
          <h3 class="text-center">Update Test Script Details:</h3>
          <div class="row">
            <div class="col form-group1">
              <label for="process">Process</label>
              <input
                id="process"
                formControlName="process"
                class="form-control1"
                placeholder="Process"
              />
              <div
                *ngIf="
                  editForm.get('process')?.invalid &&
                  editForm.get('process')?.touched
                "
                class="text-danger"
              >
                <small *ngIf="editForm.get('process')?.errors?.['required']"
                  >Process is required.</small
                >
                <small *ngIf="editForm.get('process')?.errors?.['minlength']"
                  >Process must be at least 10 characters long.</small
                >
                <small *ngIf="editForm.get('process')?.errors?.['maxlength']"
                  >Process cannot be more than 100 characters long.</small
                >
              </div>
            </div>
            <div class="col form-group1">
              <label for="test">Test</label>
              <input id="test" formControlName="test" class="form-control1" placeholder="Test"
              />
              <div
                *ngIf="
                  editForm.get('test')?.invalid && editForm.get('test')?.touched
                "
                class="text-danger"
              >
                <small *ngIf="editForm.get('test')?.errors?.['required']"
                  >Test is required.</small
                >
                <small *ngIf="editForm.get('test')?.errors?.['minlength']"
                  >Test must be at least 10 characters long.</small
                >
                <small *ngIf="editForm.get('test')?.errors?.['maxlength']"
                  >Test cannot be more than 100 characters long.</small
                >
              </div>
            </div>
          </div>
          <div class="form-group1">
            <label for="testScriptDescription">Description</label>
            <textarea
              id="testScriptDescription"
              formControlName="testScriptDescription"
              class="form-control1"  placeholder="Description"
            ></textarea>
            <div
              *ngIf="
                editForm.get('testScriptDescription')?.invalid &&
                editForm.get('testScriptDescription')?.touched
              "
              class="text-danger"
            >
              <small
                *ngIf="editForm.get('testScriptDescription')?.errors?.['required']"
                >Description is required.</small
              >
              <small
                *ngIf="editForm.get('testScriptDescription')?.errors?.['minlength']"
                >Description must be at least 10 characters long.</small
              >
              <small
                *ngIf="editForm.get('testScriptDescription')?.errors?.['maxlength']"
                >Description cannot be more than 200 characters long.</small
              >
            </div>
          </div>
          <div class="form-group1 text-center">
            <button type="submit" class="btn1 btn-primary1" style="margin-right: 10px;" >Save</button>
            <button type="button" class="btn1 btn-cancel1" (click)="toggleEditForm()">Cancel</button>
          </div>

        </div>

      </form>
    </ng-template>

    <br />
    <form [formGroup]="editForm">
      <div class="text-center"><h3>Test Steps</h3></div>
      <table class="content-tableR">
        <thead class="thead-dark">
          <tr>
            <th style="text-align: center; width: 8%">Order</th>
            <th style="width: 15%">Description</th>
            <th style="width: 10%">Role</th>
            <th style="width: 20%">Step</th>
            <th style="width: 15%">Data</th>
            <th style="width: 20%">Expected Outcome</th>
            <th style="width: 20%">Additional Info</th>
            <th style="text-align: center; width: 8%" *ngIf="testScript.statusTypeId === 1 || testScript.statusTypeId === 3">Actions</th>
            <th style="text-align: center; width: 10%" *ngIf="testScript.statusTypeId === 6 || testScript.statusTypeId === 8 || testScript.statusTypeId === 5">Feedback</th>
            <th style="text-align: center; width: 8%" *ngIf="testScript.statusTypeId === 6 || testScript.statusTypeId === 8 || testScript.statusTypeId === 5">Result</th>
          </tr>
        </thead>
        <tbody formArrayName="testSteps" style="vertical-align: middle">
          <tr
            *ngFor="let step of testStepsFormArray.controls; let i = index"
            [formGroupName]="i"
          >
            <td style="text-align: center">{{ i + 1 }}</td>
            <td *ngIf="editingStepIndex !== i">
              {{ step.value.testStepDescription }}
            </td>
            <td *ngIf="editingStepIndex === i">
              <input
                class="form-control"
                formControlName="testStepDescription"  placeholder="Description"
              />
              <div
                *ngIf="
                  step.get('testStepDescription')?.invalid &&
                  step.get('testStepDescription')?.touched
                "
                class="text-danger"
              >
                <small
                  *ngIf="step.get('testStepDescription')?.errors?.['required']"
                  >Description is required.</small
                >
                <small
                  *ngIf="step.get('testStepDescription')?.errors?.['minlength']"
                  >Description must be at least 10 characters long.</small
                >
                <small
                  *ngIf="step.get('testStepDescription')?.errors?.['maxlength']"
                  >Description cannot exceed 500 characters.</small
                >
              </div>
            </td>
            <td *ngIf="editingStepIndex !== i">
              {{ step.value.testStepRole }}
            </td>
            <td *ngIf="editingStepIndex === i">
              <input class="form-control" formControlName="testStepRole"  placeholder="Role"/>
              <div
                *ngIf="
                  step.get('testStepRole')?.invalid &&
                  step.get('testStepRole')?.touched
                "
                class="text-danger"
              >
                <small *ngIf="step.get('testStepRole')?.errors?.['required']"
                  >Role is required.</small
                >
                <small *ngIf="step.get('testStepRole')?.errors?.['minlength']"
                  >Role must be at least 2 characters long.</small
                >
                <small *ngIf="step.get('testStepRole')?.errors?.['maxlength']"
                  >Role cannot exceed 50 characters.</small
                >
              </div>
            </td>
            <td *ngIf="editingStepIndex !== i">
              {{ step.value.testStepName }}
            </td>
            <td *ngIf="editingStepIndex === i">
              <input class="form-control" formControlName="testStepName" placeholder="Step"/>
              <div
                *ngIf="
                  step.get('testStepName')?.invalid &&
                  step.get('testStepName')?.touched
                "
                class="text-danger"
              >
                <small *ngIf="step.get('testStepName')?.errors?.['required']"
                  >Step is required.</small
                >
                <small *ngIf="step.get('testStepName')?.errors?.['minlength']"
                  >Step must be at least 10 characters long.</small
                >
                <small *ngIf="step.get('testStepName')?.errors?.['maxlength']"
                  >Step cannot exceed 500 characters.</small
                >
              </div>
            </td>
            <td *ngIf="editingStepIndex !== i">{{ step.value.testData }}</td>
            <td *ngIf="editingStepIndex === i">
              <input class="form-control" formControlName="testData" placeholder="Test Data"/>
              <div
                *ngIf="
                  step.get('testData')?.invalid && step.get('testData')?.touched
                "
                class="text-danger"
              >
                <small *ngIf="step.get('testData')?.errors?.['required']"
                  >Data is required.</small
                >
                <small *ngIf="step.get('testData')?.errors?.['minlength']"
                  >Data must be at least 1 characters long.</small
                >
                <small *ngIf="step.get('testData')?.errors?.['maxlength']"
                  >Data cannot exceed 500 characters.</small
                >
              </div>
            </td>
            <td *ngIf="editingStepIndex !== i">{{ step.value.expectedOutcome }}</td>
            <td *ngIf="editingStepIndex === i">
              <input class="form-control" formControlName="expectedOutcome" placeholder="Expected Outcome"/>
              <div
                *ngIf="
                  step.get('expectedOutcome')?.invalid &&
                  step.get('expectedOutcome')?.touched
                "
                class="text-danger"
              >
                <small *ngIf="step.get('expectedOutcome')?.errors?.['required']"
                  >Expected Outcome is required. If not applicable, please enter 'N/A'.</small
                >
                <small *ngIf="step.get('expectedOutcome')?.errors?.['minlength']"
                  >Expected Outcome must be at least 3 characters long.</small
                >
                <small *ngIf="step.get('expectedOutcome')?.errors?.['maxlength']"
                  >Expected Outcome cannot exceed 500 characters.</small
                >
              </div>
            </td>
            <td *ngIf="editingStepIndex !== i">
              {{ step.value.additionalInfo }}
            </td>
            <td *ngIf="editingStepIndex === i">
              <input class="form-control" formControlName="additionalInfo" placeholder="Additional Info"/>
              <div
                *ngIf="
                  step.get('additionalInfo')?.invalid &&
                  step.get('additionalInfo')?.touched
                "
                class="text-danger"
              >
                <small *ngIf="step.get('additionalInfo')?.errors?.['required']"
                  >Additional Info is required. If not applicable, please enter 'N/A'.</small
                >
                <small *ngIf="step.get('additionalInfo')?.errors?.['minlength']"
                  >Additional Info must be at least 3 characters long.</small
                >
                <small *ngIf="step.get('additionalInfo')?.errors?.['maxlength']"
                  >Additional Info cannot exceed 500 characters.</small
                >
              </div>
            </td>
            <td style="text-align: center;" *ngIf="testScript.statusTypeId === 1 || testScript.statusTypeId === 3">
              <ng-container *ngIf="editingStepIndex !== i">
                <box-icon
                  name="edit"
                  color="#001844"
                  (click)="startEditing(i)"
                ></box-icon>
                <box-icon
                  name="trash"
                  color="#ef0000"
                  (click)="deleteTestStep(i)"
                ></box-icon>
              </ng-container>
              <ng-container
                *ngIf="editingStepIndex === i && addingNewStepIndex === null"
              >
                <box-icon
                  name="check-square"
                  type="solid"
                  color="#001844"
                  (click)="saveTestStep(i)"
                ></box-icon>
                <box-icon
                  name="x-square"
                  type="solid"
                  color="#ef0000"
                  (click)="cancelEdit()"
                ></box-icon>
              </ng-container>
              <ng-container *ngIf="addingNewStepIndex === i">
                <box-icon
                  name="check-square"
                  type="solid"
                  color="#001844"
                  (click)="saveNewTestStep(i)"
                ></box-icon>
                <box-icon
                  name="x-square"
                  type="solid"
                  color="#ef0000"
                  (click)="cancelEdit()"
                ></box-icon>
              </ng-container>
            </td>
            <td *ngIf="editingStepIndex !== i && (testScript.statusTypeId === 6 || testScript.statusTypeId === 8 || testScript.statusTypeId === 5)">{{ step.value.feedback}}</td>
            <td *ngIf="editingStepIndex !== i && (testScript.statusTypeId === 6 || testScript.statusTypeId === 8 || testScript.statusTypeId === 5)">{{ step.value.stepResult }}</td>
          </tr>
          <tr *ngIf="testScript.statusTypeId === 1 || testScript.statusTypeId === 3">
            <td colspan="10" style="text-align: end;" >
              <box-icon
                name="plus-circle"
                (click)="addNewTestStepRow(testStepsFormArray.length)"
                style="margin-right: 25px"
              ></box-icon>
            </td>
          </tr>
        </tbody>
      </table>
    </form>

    <div class="mt-4" style="padding-top: 20px">
      <div class="row">
        <div class="col">
          <h3>Defects: {{ defects.length }}</h3>
        </div>
        <div class="col text-end">
          <button (click)="openModal()" class="btn1 btn-primary1" *ngIf="testScript.isDeleted === false">
            Log New Defect +
          </button>
          <box-icon
              class="chevron-icon"
              name="chevron-down"
              [@rotateChevron]="showDefects"
              (click)="toggleShowDefects()"
            ></box-icon>
        </div>        
      </div>
        <hr style="margin-bottom: 0px; margin-top: 5px" />
          <div style="padding: 10px">
            <div *ngIf="showDefects" [@toggleTable]>
              <div *ngIf="defects.length === 0" class="alert text-center" style="color: #001844; border: solid 1px #001844; background-color: #869ec3; margin-top: 10px;">
                <b>No results found!</b>
              </div>
            <table *ngIf="defects.length> 0" class="content-table mt-1">
              <thead>
                <tr>
                  <th style="width: 20%">Description</th>
                  <!-- <th style="width:20%">Status</th> -->
                  <th style="width: 20%">Date Logged</th>
                  <th style="width: 10%; text-align: center">Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let d of defects | paginate: { itemsPerPage: 3, currentPage: page }">
                  <td>{{ d.defectDescription }}</td>
                  <!-- <td>{{ d.defectStatus }}</td> -->
                  <td>{{ getFormattedDate(d.dateLogged) }}</td>
                  <td style="text-align: center">
                    <box-icon
                      name="show"
                      color="#001844"
                      [routerLink]="['/defects', d.defectId]"
                    ></box-icon>
                    <!-- <box-icon name='edit' color='#001844' [routerLink]="['/testscript-detail', ts.testScriptId]"></box-icon> -->
                    <box-icon
                      name="trash"
                      color="#ef0000"
                      (click)="deleteDefect(d)"
                    ></box-icon>
                  </td>
                </tr>
              </tbody>
            </table>
            <pagination-controls *ngIf="defects.length > 0" (pageChange)="page = $event" class="text-end"></pagination-controls>
          </div>
        </div>
      </div>
    </div>

   
    <div class="mt-2" style="padding-top: 20px"></div>
      <div class="row">
        <div class="col">
          <h3>TestScript Tags: {{ tags.length }}</h3>
        </div>
        <div class="col text-end">
          <button class="btn1 btn-primary1" (click)="openTagModal()">
            Apply TestScript Tag +
          </button>
          <box-icon
            class="chevron-icon"
            name="chevron-down"
            [@rotateChevron]="showTags"
            (click)="toggleShowTags()"
          ></box-icon>
        </div>
      </div>
      <!-- Testscript Tags Section -->
      <hr *ngIf="showTags" style="margin-bottom: 0px; margin-top: 5px" />
      <hr *ngIf="!showTags" style="margin-bottom: 30px; margin-top: 5px" />
      <div class="mb-5" *ngIf="showTags" [@toggleTable]>
        <div *ngIf="tags.length === 0" class="alert text-center" style="color: #001844; border: solid 1px #001844; background-color: #869ec3; margin-top: 10px;">
          <b>No results found!</b>
        </div>
        <div *ngIf="tags.length > 0">
          <table class="content-table mt-3">
            <thead>
              <tr>
                <th width="20%">Tag Name</th>
                <th width="20%">Tag Type</th>
                <th width="20%">Tag Description</th>
                <th width="30%"></th>
                <th width="10%" class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let tag of tags | paginate: { itemsPerPage: 3, currentPage: page }">
                <td width="20%"> {{ tag.tagName }} </td>
                <td width="20%"> {{ getTagTypeName(tag.tagTypeId) }} </td>
                <td width="20%"> {{ tag.tagDescription }} </td>
                <td width="30%"> </td>
                <td width="10%" class="text-center">
                  <box-icon
                  name="trash"
                  color="#ef0000"
                  (click)="removeTag(tag.tagId)"
                ></box-icon>
                </td>
              </tr>
            </tbody>
          </table>
          <pagination-controls *ngIf="tags.length > 0" (pageChange)="page = $event" class="text-end"></pagination-controls>
        </div>  
      </div>
        
      <!-- Modal for selecting and applying a tag -->
      <div class="modal1" tabindex="-1" [ngClass]="{'show': showTagModal}" *ngIf="showTagModal">
        <div class="modal-dialog1 modal-dialog-centered">
          <div class="modal-content1">
            <div class="modal-header1 row">
              <div class="col"><h5><b>Apply a Tag</b></h5></div>
              <div class="col text-end"><box-icon name="x" (click)="closeTagModal()"></box-icon></div>
            </div>
            <div class="modal-body1">
              <div *ngIf="availableTags.length === 0" class="alert text-center" style="color: #001844; border: solid 1px #001844; background-color: #869ec3; margin-top: 10px;">
                <b>No tags found!</b>
              </div>
              <div *ngIf="availableTags.length > 0" class="table-container">
                <table class="content-table mt-2">
                  <thead>
                    <tr>
                      <th>Tag Name</th>
                      <th>Tag Type</th>
                      <th>Tag Description</th>
                      <th width="20%" class="text-center">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let tag of availableTags">
                      <td>{{ tag.tagName }}</td>
                      <td>{{ getTagTypeName(tag.tagTypeId) }}</td>
                      <td>{{ tag.tagDescription }}</td>
                      <td style="text-align: center;">
                        <box-icon name='check-square' color='#001844' (click)="ApplyTag(tag.tagId)"></box-icon>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="form-group1 text-center mt-3">
                <button type="button" class="btn btn-cancel1" (click)="closeTagModal()">Close</button>
              </div>
            </div>
            
          </div>
        </div>
      </div>

    <div
      *ngIf="showModal"
      id="logDefectForm"
      [ngClass]="{ show: showModal }"
      class="modal1"
    >
      <div class="modal-dialog1 modal-dialog-centered">
        <div class="modal-content1">
          <div class="modal-header1 row">
            <div class="col">
              <h2><b>Log New Defect</b></h2>
            </div>
            <div class="col text-end">
              <box-icon name="x" (click)="closeModal()"></box-icon>
            </div>
          </div>
          <div class="modal-body1">
            <form [formGroup]="logDefectForm" (ngSubmit)="logDefect()">
              <div class="row">
                <div class="form-group1">
                  <label for="defectDescription">Description</label>
                  <textarea
                    id="defectDescription"
                    formControlName="defectDescription"
                    class="form-control1" placeholder="Enter the defect description"
                  ></textarea>
                  <div
                    *ngIf="
                      logDefectForm.get('defectDescription')?.invalid &&
                      logDefectForm.get('defectDescription')?.touched
                    "
                    class="text-danger"
                  >
                    <small
                      *ngIf="logDefectForm.get('defectDescription')?.errors?.['required']"
                      >Description is required.</small
                    >
                    <small
                      *ngIf="logDefectForm.get('defectDescription')?.errors?.['minlength']"
                      >Description must be at least 10 characters long.</small
                    >
                    <small
                      *ngIf="logDefectForm.get('defectDescription')?.errors?.['maxlength']"
                      >Description cannot be more than 150 characters long.</small
                    >
                  </div>
                </div>
                <input type="hidden" formControlName="defectId" />
                <div class="form-group1 text-center">
                  <button
                    type="submit"
                    class="btn1 btn-primary1"
                    style="margin-right: 10px"
                  >
                    Create
                  </button>
                  <button
                    type="button"
                    class="btn1 btn-cancel1"
                    (click)="closeModal()"
                  >
                    Cancel
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <!-- ********************Bootstrap OffCanvas for Comments****************-->
    <div
      class="offcanvas offcanvas-end"
      tabindex="-1"
      id="offcanvasRight"
      aria-labelledby="offcanvasRightLabel"
    >
      <div class="offcanvas-header">
        <h5 id="offcanvasRightLabel">Comments</h5>
        <button
          type="button"
          class="btn-close text-reset"
          data-bs-dismiss="offcanvas"
          aria-label="Close"
          (click)="hideTooltip('close-comment-icon')" id="close-comment-icon"
          data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Close Comments"
        ></button>
      </div>
      <div class="offcanvas-body">
        <div class="col text-center">
          <box-icon
            *ngIf="showAddCommentButton"
            name="comment-add"
            color="#001844"
            (click)="toggleAddComment(); hideTooltip('add-comment-icon')" id="add-comment-icon"
            data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Add New Comment"
          ></box-icon>
          <div *ngIf="showAddCommentform">
            <form [formGroup]="logCommentForm" (ngSubmit)="loadComments()">
              <div class="container">
                <div class="row">
                  <label for="commentTitle">Comment Title *</label>
                  <input
                    type="text"
                    id="commentTitle"
                    class="form-control1"
                    formControlName="commentTitle"
                    placeholder="Comment Title"
                    required
                  />
                </div>
                <div class="row">
                  <label for="commentLine">Comment Line *</label>
                  <input
                    type="text"
                    id="commentLine"
                    class="form-control1"
                    formControlName="commentLine"
                    (input)="TrackerMethod1($event)"
                    placeholder="Comment Title"
                    required
                  />
                </div>
              </div>
              <box-icon
                name="check-square"
                color="#001844"
                (click)="logComment(); hideTooltip('submit-add-comment-icon')" id="submit-add-comment-icon"
                data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Submit"
                title="Add Comment"
              ></box-icon>
              <box-icon
                name="x-square"
                type="solid"
                color="#ef0000"
                (click)="cancelAddComment(); hideTooltip('cancel-add-comment-icon')" id="cancel-add-comment-icon"
                data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="cancel"
              ></box-icon>
            </form>
          </div>
          <div *ngIf="showEditCommentform">
            <form [formGroup]="editCommentForm" (ngSubmit)="loadComments()">
              <div class="container">
                <div class="row">
                  <label for="commentTitle">Comment Title *</label>
                  <input
                    type="text"
                    id="commentTitle"
                    class="form-control1"
                    formControlName="commentTitle"
                    placeholder="Comment Title"
                    required
                  />
                </div>
                <div class="row">
                  <label for="commentLine">Comment Line *</label>
                  <input
                    type="text"
                    id="commentLine"
                    class="form-control1"
                    formControlName="commentLine"
                    placeholder="Comment Line"
                    required
                  />
                </div>
              </div>
              <box-icon
                type="submit"
                name="check-square"
                color="#001844"
                (click)="confirmUpdateComment(); hideTooltip('submit-edit-comment-icon')" id="submit-edit-comment-icon"
                data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Submit"
              ></box-icon>
              <box-icon
                name="x-square"
                type="solid"
                color="#ef0000"
                (click)="cancelUpdateComment(); hideTooltip('cancel-edit-comment-icon')" id="cancel-edit-comment-icon"
                data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Cancel"
              ></box-icon>
            </form>
          </div>
          <hr />

          <div class="row justify-content-between mb-0 mt-0" *ngIf="showCommentsList">
            <div class="col-12">
              <div class="input-group">
                <input
                  type="text"
                  class="form-control"
                  placeholder="Search Comments..."
                  (input)="onCommentSearch($event)"
                />
                <div class="input-group-append">
                  <span class="input-group-text"
                    ><box-icon name="search"></box-icon
                  ></span>
                </div>
              </div>
            </div>
          </div>
          <hr />

          <div *ngIf="showCommentsList">
            <div class="container1" *ngFor="let comment of filteredComments">
              <h6>
                <b>{{ comment.commentTitle }}</b>
              </h6>
              <p style="font-size: 10px" *ngIf="comment.isModified == true">
                (Edited On:
                {{ comment.dateModified | date : "dd-MM-yyyy HH:mm" }})
              </p>
              <hr />
              <p style="font-size: 13px">{{ comment.commentLine }}</p>

              <!--
              <div class="row">
                <div class="col-md-6">
                  <a>_____</a>
                </div>
                <div class="col-md-6">
                  <a>_____</a>
                </div>
              </div>
              -->

              <div class="row">
                <div class="col-md-6">
                  <p style="font-size: 10px" *ngIf="user$ | async as user">
                    {{ getCommentUser(comment) }}
                  </p>
                </div>
                <div class="col-md-6">
                  <p style="font-size: 10px">
                    {{ comment.commentDate | date : "dd-MM-yyyy HH:mm" }}
                  </p>
                </div>
              </div>
              <div *ngIf="user$ | async as user">
                <box-icon
                  *ngIf="user.email == comment.userEmail"
                  name="edit"
                  color="#001844"
                  (click)="invokeUpdateComment(comment.commentId); hideTooltip('edit-comment-icon-' + comment.commentId)" [id]="'edit-comment-icon-' + comment.commentId"
                  data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Edit Comment"
                ></box-icon>
                <box-icon
                  *ngIf="user.email == comment.userEmail"
                  name="trash"
                  color="#ef0000"
                  (click)="confirmDeleteComment(comment.commentId); hideTooltip('delete-comment-icon')" id="delete-comment-icon"
                  data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Delete Comment"
                ></box-icon>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- ********************OffCanvas Ends****************-->
    <div *ngIf="showThemeModal" id="selectThemeModal" [ngClass]="{'show': showThemeModal}" class="modal1">
      <div class="modal-dialog1 modal-dialog-centered">
        <div class="modal-content1">
          <div class="modal-header1 row">
            <div class="col">
              <h2><b>Select Client Theme</b></h2>
            </div>
            <div class="col text-end">
              <box-icon name="x" (click)="closeThemeList()"></box-icon>
            </div>
          </div>
          <p style="color: red; padding: 20px;" class="text-center">A theme ensures that the exported test script is distinguishable by the client its project belongs to! Please ensure that the client has at least 1!</p>

          <div *ngIf="themes.length === 0" class="modal-body1 alert text-center" style="color: #001844; border: solid 1px #001844; background-color: #869ec3; margin: 10px;">
            <b>There are no themes in this client, please make sure that the client has at least one theme before you can proceed</b>
          </div>
          <div class="modal-body1" *ngIf="themes.length > 0">
            <div class="table-container">
              <table class="content-table">
                <thead>
                  <tr>
                    <th style="width:30%">Theme Name</th>
                    <th style="width:20%; text-align: center;">Select</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let theme of themes">
                    <td>{{ theme.themeName }}</td>
                    <td style="text-align: center;">
                      <box-icon name="check-square" color="#001844" (click)="loadLogos(theme.themeId!)"></box-icon>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="form-group1 text-center">
              <button type="button" class="btn1 btn-cancel1" style="margin-top: 20px;" (click)="closeThemeList()">Cancel</button>
            </div>
          </div>
        </div>
      </div>
    </div>
<div *ngIf="showLogoModal" id="selectLogoModal" [ngClass]="{'show': showLogoModal}" class="modal1">
      <div class="modal-dialog1 modal-dialog-centered">
        <div class="modal-content1">
          <div class="modal-header1 row">
            <div class="col">
              <h2><b>Select Theme Logo</b></h2>
            </div>
            <div class="col text-end">
              <box-icon name="x" (click)="closeLogoList()"></box-icon>
            </div>
          </div>
          <div *ngIf="logos.length === 0" class="modal-body1 alert text-center" style="color: #001844; border: solid 1px #001844; background-color: #869ec3; margin: 10px;">
            <b>There are no logos in this client theme, please select a different theme or make sure that the theme has at least one logo before you can proceed</b>
          </div>
          <div class="modal-body1" *ngIf="logos.length > 0">
            <div class="table-container">
              <table class="content-table">
                <thead>
                  <tr>
                    <th style="width:30%">Logo</th>
                    <th style="width:20%; text-align: center;">Select</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let logo of logos">
                    <!-- <td>{{logo.logoImage }}</td> -->
                     <td><img [src]="logo.logoImage" alt="logo" style="max-width: 150px; cursor: pointer;"></td>
                    <td style="text-align: center;">
                      <box-icon name="check-square" color="#001844" (click)="loadColours(logo.logoId!)"></box-icon>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="form-group1 text-center">
              <button type="button" class="btn1 btn-cancel1" style="margin-top: 20px;" (click)="closeLogoList()">Cancel</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div *ngIf="showColoursModal" id="selectColourModal" [ngClass]="{'show': showColoursModal}" class="modal1">
      <div class="modal-dialog1 modal-dialog-centered">
        <div class="modal-content1">
          <div class="modal-header1 row">
            <div class="col">
              <h2><b>Select Theme Colour</b></h2>
            </div>
            <div class="col text-end">
              <box-icon name="x" (click)="closeColoursList()"></box-icon>
            </div>
          </div>
          <div *ngIf="colours.length === 0" class="modal-body1 alert text-center" style="color: #001844; border: solid 1px #001844; background-color: #869ec3; margin: 10px;">
            <b>There are no colours in this client theme, please select a different theme or make sure that the theme has at least one colour before you can proceed</b>
          </div>
          <div class="modal-body1">
            <div class="table-container">
              <table class="content-table">
                <thead>
                  <tr>
                    <th style="width:30%">Colour</th>
                    <th style="width:20%; text-align: center;">Select</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let colour of colours">
                    <td><div [style.backgroundColor]="colour.colour" style="width: 100px; height: 100px; border-radius: 5px;"><b>{{colour.colour}}</b></div></td>
                    <td style="text-align: center;">
                      <box-icon name="check-square" color="#001844" (click)="finaliseTheme(colour.colourSchemeId!)"></box-icon>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="form-group1 text-center">
              <button type="button" class="btn1 btn-cancel1" style="margin-top: 20px;" (click)="closeColoursList()">Cancel</button>
            </div>
          </div>
        </div>
      </div>
    </div>






<!-- Modal for assigning a team -->
<div class="modal1" tabindex="-1" [ngClass]="{'show': showAssignTeamMemberModal}" *ngIf="showAssignTeamMemberModal">
  <div class="modal-dialog1 modal-dialog-centered">
    <div class="modal-content1">
      <div class="modal-header1 row">
        <div class="col" style="color: #001844;"><h5><b>Assign Team Member</b></h5></div>
        <div class="col text-end"><box-icon name='x' (click)="closeAssignTeamMemberModal()"></box-icon></div>
      </div>
      <!-- <div class="modal-header1">
        <h5 class="modal-title1">Assign Team</h5>
        <button type="button" class="btn btn-close1" (click)="closeAssignTeamModal()">Close</button>
      </div> -->
      <div class="modal-body1">
        <table class="content-table mt-2">
          <thead>
            <tr>
              <th width="25%">Team Member Name</th>
              <th width="35%">Team Member Surname</th>
              <th width="25%">Team Member Email</th>
              <th width="15%">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let tm of teamMembers">
              <td>{{ tm.userFirstName }}</td>
              <td>{{ tm.userSurname }}</td>
              <td>{{ tm.userEmailAddress }}</td>
              <td>
                <button class="btn" (click)="assignTs(tm.userId ,tm.teamId)" style="background-color: #869ec3; color: #001844;">Assign</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="modal-footer1 d-flex justify-content-center">
        <button type="button" class="btn btn-secondary" (click)="closeAssignTeamMemberModal()">Close</button>
      </div>
    </div>
  </div>

  </div>









    
    <!-- </div>
</div> -->

    <!------------------------------------------------------------------------------------------------------------------------------------------->
    <!------------------------------------------------------------------------------------------------------------------------------------------->
    <!------------------------------------------------------------------------------------------------------------------------------------------->
    <!------------------------------------------------------------------------------------------------------------------------------------------->
    <!------------------------------------------------------------------------------------------------------------------------------------------->
    <!------------------------------------------------------------------------------------------------------------------------------------------->
    <!-- OLD CODE-->

    <!-- <div class="container1">
  <box-icon name="arrow-back" color="#001844" (click)="goBack()">Back</box-icon>
  <div class="subheader1">
    <div *ngIf="testScript">
      <div *ngIf="!showEditForm; else editTestScriptDiv">
        <div class="card text-center">
          <div class="card-header card-header-custom">{{ testScript.process }}</div>
          <div class="card-body">
            <p class="card-text mb-1"><span class="bold-text">Test:</span> {{ testScript.test }}</p>
            <p class="card-text mb-1"><span class="bold-text">Description:</span> {{ testScript.testScriptDescription }}</p>
            <p class="card-text mb-1"><span class="bold-text">Status:</span> {{ testScript.statusNameDisplayed }}</p>
            <p *ngIf="testScript.isAssigned" class="card-text mb-1 text-danger"><span class="bold-text">Assigned</span></p>
          </div>
          <div class="card-footer text-body-secondary" *ngIf="testScript.statusTypeId === 1 || testScript.statusTypeId === 2">
            <box-icon name="edit" color="#001844" (click)="toggleEditForm()"></box-icon>
            <box-icon name="archive-in" color="#ef0000" (click)="deleteTestScript()"></box-icon>
          </div>
          <div class="card-footer text-body-secondary">
            <box-icon name="link-external" color="#001844" (click)="exportTs()"></box-icon>
          </div>
        </div>
      </div>
    </div>

    <ng-template #editTestScriptDiv>
      <form [formGroup]="editForm" (ngSubmit)="saveTestScriptDetails()">
        <div class="row">
          <div class="col form-group1">
            <label for="process">Process</label>
            <input id="process" formControlName="process" class="form-control1" />
            <div *ngIf="editForm.get('process')?.invalid && editForm.get('process')?.touched" class="text-danger">
              <small *ngIf="editForm.get('process')?.errors?.['required']">Process is required.</small>
              <small *ngIf="editForm.get('process')?.errors?.['minlength']">Process must be at least 10 characters long.</small>
              <small *ngIf="editForm.get('process')?.errors?.['maxlength']">Process cannot be more than 30 characters long.</small>
            </div>
          </div>
          <div class="col form-group1">
            <label for="test">Test</label>
            <input id="test" formControlName="test" class="form-control1" />
            <div *ngIf="editForm.get('test')?.invalid && editForm.get('test')?.touched" class="text-danger">
              <small *ngIf="editForm.get('test')?.errors?.['required']">Test is required.</small>
              <small *ngIf="editForm.get('test')?.errors?.['minlength']">Test must be at least 10 characters long.</small>
              <small *ngIf="editForm.get('test')?.errors?.['maxlength']">Test cannot be more than 30 characters long.</small>
            </div>
          </div>
        </div>

        <div class="form-group1">
          <label for="testScriptDescription">Description</label>
          <textarea id="testScriptDescription" formControlName="testScriptDescription" class="form-control1"></textarea>
          <div *ngIf="editForm.get('testScriptDescription')?.invalid && editForm.get('testScriptDescription')?.touched" class="text-danger">
            <small *ngIf="editForm.get('testScriptDescription')?.errors?.['required']">Description is required.</small>
            <small *ngIf="editForm.get('testScriptDescription')?.errors?.['minlength']">Description must be at least 10 characters long.</small>
            <small *ngIf="editForm.get('testScriptDescription')?.errors?.['maxlength']">Description cannot be more than 150 characters long.</small>
          </div>
        </div>
      </form>
    </ng-template>

    <br />
    <form [formGroup]="editForm">
      <div class="text-center"><h3> Test Steps</h3></div>
      <table class="table table-striped table-bordered table-rounded">
        <thead class="thead-dark">
          <tr>
            <th style="text-align: center; width: 5%;">Order</th>
            <th style="width: 20%;">Description</th>
            <th style="width: 10%;">Role</th>
            <th style="width: 25%;">Step</th>
            <th style="width: 15%;">Data</th>
            <th style="width: 20%;">Additional Info</th>
            <th style="text-align: center; width: 5%;">Actions</th>
          </tr>
        </thead>
        <tbody formArrayName="testSteps" style="vertical-align: middle;">
          <tr *ngFor="let step of testStepsFormArray.controls; let i = index" [formGroupName]="i">
          </tr>
          <tr>
            <td colspan="7" style="text-align: end;">
              <box-icon name='plus-circle' (click)="addNewTestStepRow(testStepsFormArray.length)" style="margin-right: 25px;"></box-icon>
            </td>
          </tr>
        </tbody>
      </table>
    </form>

    <div class="mt-4" style="padding-top: 20px">
      <div class="row">
        <div class="col">
          <h3>Defects: {{ defects.length }}</h3>
        </div>
        <div class="col text-end">
          <button (click)="openModal()" class="btn1 btn-primary1">Log New Defect +</button>
        </div>
        <hr style="margin-bottom: 0px; margin-top: 5px" />
        <div *ngIf="showDefects" [@toggleTable]>
          <div *ngIf="defects" class="content-table mt-3" style="padding: 10px;">
            <table class="content-table">
              <thead>
                <tr>
                  <th style="width:20%">Description</th>
                  <th style="width:20%">Date Logged</th>
                  <th style="width:20%; text-align: center;">Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let d of defects">
                  <td>{{ d.defectDescription }}</td>
                  <td>{{ getFormattedDate(d.dateLogged) }}</td>
                  <td style="text-align: center;">
                    <box-icon name='show' color='#001844' [routerLink]="['/defects', d.defectId]"></box-icon>
                    <box-icon name='trash' color='#ef0000' (click)="deleteDefect(d)"></box-icon>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div *ngIf="showModal" id="logDefectForm" [ngClass]="{'show': showModal}" class="modal1">
          <div class="modal-dialog1 modal-dialog-centered">
            <div class="modal-content1">
              <div class="modal-header1 row">
                <div class="col"><h2><b>Log New Defect</b></h2></div>
                <div class="col text-end"><box-icon name='x' (click)="closeModal()"></box-icon></div>
              </div>
              <div class="modal-body1">
                <form [formGroup]="logDefectForm" (ngSubmit)="logDefect()">
                  <div class="row">
                    <div class="form-group1">
                      <label for="defectDescription">Description</label>
                      <textarea id="defectDescription" formControlName="defectDescription" class="form-control1"></textarea>
                      <div *ngIf="logDefectForm.get('defectDescription')?.invalid && logDefectForm.get('defectDescription')?.touched" class="text-danger">
                        <small *ngIf="logDefectForm.get('defectDescription')?.errors?.['required']">Description is required.</small>
                        <small *ngIf="logDefectForm.get('defectDescription')?.errors?.['minlength']">Description must be at least 10 characters long.</small>
                        <small *ngIf="logDefectForm.get('defectDescription')?.errors?.['maxlength']">Description cannot be more than 100 characters long.</small>
                      </div>
                    </div>
                    <input type="hidden" formControlName="defectId" />
                    <div class="form-group1 text-center">
                      <button type="submit" class="btn1 btn-primary1" style="margin-right: 10px">Create</button>
                      <button type="button" class="btn1 btn-cancel1" (click)="closeModal()">Cancel</button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>

        <div class="form-group1 text-center">
          <button type="submit" class="btn1 btn-primary1" style="margin-right: 10px;">Create</button>
          <button type="button" class="btn1 btn-cancel1" (click)="closeModal()">Cancel</button>
        </div>
      </div>
    </div>
  </div>
</div> -->
  </div>
</div>